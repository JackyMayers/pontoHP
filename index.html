<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ajuste de Ponto</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #dcdcdc;
            color: #333;
            padding: 20px;
        }
        .container {
            max-width: 600px;
            margin: auto;
            padding: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
        }
        input, textarea, button {
            margin: 5px 0;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: calc(100% - 22px);
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        .result {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Ajuste de Ponto</h1>
        <form id="timeForm">
            <h2>Entradas do Bot</h2>
            <textarea id="botEntries" rows="5" placeholder="Cole as entradas do bot aqui, uma por linha (ex: 10/09/24 - 23 minutos)"></textarea>
            <button type="button" onclick="calculateBotEntries()">Calcular Tempo do Bot</button>
            
            <h2>Ajuste de Ponto Manual</h2>
            <textarea id="manualEntries" rows="5" placeholder="Nome: Jacky Mayers Antonelli&#10;Passaporte: 2885&#10;Data: 10/09/2024&#10;Entrada: 19:57&#10;Saída: 21:40"></textarea>
            <button type="button" onclick="calculateManualPoint()">Calcular Ajuste de Ponto</button>
            
            <h2>Adicionar Horas e Minutos</h2>
            <input type="number" id="extraHours" placeholder="Horas" />
            <input type="number" id="extraMinutes" placeholder="Minutos" />
            <button type="button" onclick="addExtraTime()">Adicionar Tempo</button>
            
            <h2>Justificativa</h2>
            <textarea id="justification" rows="3" placeholder="Justifique caso a meta não seja batida"></textarea>
        </form>
        
        <div class="result">
            <h2>Resultado</h2>
            <p id="totalTime">Tempo total trabalhado: 0 horas e 0 minutos.</p>
            <p id="daysWorked">Dias trabalhados: 0.</p>
            <p id="metaStatus">A meta de 7 horas não foi batida. Faltam 7 horas e 0 minutos.</p>
            <p id="justificationResult"></p>
        </div>
    </div>

    <script>
        function parseTime(timeString) {
            let hours = 0;
            let minutes = 0;

            const hourMatch = timeString.match(/(\d+)\s*hora/);
            if (hourMatch) {
                hours = parseInt(hourMatch[1], 10);
            }

            const minuteMatch = timeString.match(/(\d+)\s*minuto/);
            if (minuteMatch) {
                minutes = parseInt(minuteMatch[1], 10);
            }

            return { hours, minutes };
        }

        function calculateBotEntries() {
            let botEntries = document.getElementById('botEntries').value.trim().split('\n');
            let timeMap = new Map();

            botEntries.forEach(entry => {
                let [date, time] = entry.split(' - ');
                time = time.trim();
                let timeData = parseTime(time);

                if (timeMap.has(date)) {
                    let current = timeMap.get(date);
                    current.hours += timeData.hours;
                    current.minutes += timeData.minutes;
                    if (current.minutes >= 60) {
                        current.hours += Math.floor(current.minutes / 60);
                        current.minutes = current.minutes % 60;
                    }
                } else {
                    timeMap.set(date, { hours: timeData.hours, minutes: timeData.minutes });
                }
            });

            let totalMinutes = 0;
            let totalHours = 0;
            let totalDays = timeMap.size;

            timeMap.forEach(time => {
                totalHours += time.hours;
                totalMinutes += time.minutes;
            });

            if (totalMinutes >= 60) {
                totalHours += Math.floor(totalMinutes / 60);
                totalMinutes = totalMinutes % 60;
            }

            let metaHours = 7;
            let hoursRemaining = Math.max(metaHours - totalHours, 0);
            let minutesRemaining = hoursRemaining > 0 ? Math.max(60 - totalMinutes, 0) : Math.max(metaHours * 60 - totalMinutes, 0);

            if (hoursRemaining === 0 && minutesRemaining === 0) {
                hoursRemaining = 0;
                minutesRemaining = 0;
            }

            let metaStatus = `A meta de ${metaHours} horas foi ${
                totalHours >= metaHours ? 'batida' : `não foi batida. Faltam ${hoursRemaining} horas e ${minutesRemaining} minutos.`
            } ${totalDays >= 3 ? 'A meta de 3 dias foi batida.' : `A meta de 3 dias não foi batida. Faltam ${Math.max(3 - totalDays, 0)} dias.`}`;

            document.getElementById('totalTime').innerText = `Tempo total trabalhado: ${totalHours} horas e ${totalMinutes} minutos.`;
            document.getElementById('daysWorked').innerText = `Dias trabalhados: ${totalDays}.`;
            document.getElementById('metaStatus').innerText = metaStatus;
            document.getElementById('justificationResult').innerText = document.getElementById('justification').value.trim() ? `Justificativa: ${document.getElementById('justification').value.trim()}` : '';
        }

        function calculateManualPoint() {
            let text = document.getElementById('manualEntries').value.trim();
            let lines = text.split('\n');
            let date = '';
            let entryTime = '';
            let exitTime = '';

            lines.forEach(line => {
                if (line.startsWith('Data:')) {
                    date = line.replace('Data:', '').trim();
                } else if (line.startsWith('Entrada:')) {
                    entryTime = line.replace('Entrada:', '').trim();
                } else if (line.startsWith('Saída:')) {
                    exitTime = line.replace('Saída:', '').trim();
                }
            });

            if (!date || !entryTime || !exitTime) {
                alert('Por favor, verifique o formato da entrada. Todos os campos devem estar presentes.');
                return;
            }

            let [entryHours, entryMinutes] = entryTime.split(':').map(Number);
            let [exitHours, exitMinutes] = exitTime.split(':').map(Number);

            if (isNaN(entryHours) || isNaN(entryMinutes) || isNaN(exitHours) || isNaN(exitMinutes)) {
                alert('Por favor, insira horas e minutos válidos.');
                return;
            }

            let entryDateTime = new Date(`${date.split('/').reverse().join('-')}T${entryHours.toString().padStart(2, '0')}:${entryMinutes.toString().padStart(2, '0')}:00`);
            let exitDateTime = new Date(`${date.split('/').reverse().join('-')}T${exitHours.toString().padStart(2, '0')}:${exitMinutes.toString().padStart(2, '0')}:00`);

            if (exitDateTime < entryDateTime) {
                exitDateTime.setDate(exitDateTime.getDate() + 1);
            }

            let timeDifferenceInMinutes = (exitDateTime - entryDateTime) / (1000 * 60);
            let totalHours = Math.floor(timeDifferenceInMinutes / 60);
            let totalMinutes = timeDifferenceInMinutes % 60;

            let currentTotal = document.getElementById('totalTime').innerText.match(/(\d+) horas e (\d+) minutos/);
            if (currentTotal) {
                totalHours += parseInt(currentTotal[1], 10);
                totalMinutes += parseInt(currentTotal[2], 10);
                if (totalMinutes >= 60) {
                    totalHours += Math.floor(totalMinutes / 60);
                    totalMinutes = totalMinutes % 60;
                }
            }

            let metaHours = 7;
            let hoursRemaining = Math.max(metaHours - totalHours, 0);
            let minutesRemaining = (hoursRemaining === 0) ? Math.max(60 - totalMinutes, 0) : Math.max(60 - totalMinutes, 0);

            if (hoursRemaining === 0 && minutesRemaining === 0) {
                hoursRemaining = 0;
                minutesRemaining = 0;
            }

            let metaStatus = `A meta de ${metaHours} horas foi ${
                totalHours >= metaHours ? 'batida' : `não foi batida. Faltam ${hoursRemaining} horas e ${minutesRemaining} minutos.`
            }.`;

            document.getElementById('totalTime').innerText = `Tempo total trabalhado: ${totalHours} horas e ${totalMinutes} minutos.`;
            document.getElementById('metaStatus').innerText = metaStatus;
        }

        function addExtraTime() {
            let extraHours = parseInt(document.getElementById('extraHours').value, 10) || 0;
            let extraMinutes = parseInt(document.getElementById('extraMinutes').value, 10) || 0;

            if (isNaN(extraHours) || isNaN(extraMinutes)) {
                alert('Por favor, insira horas e minutos válidos.');
                return;
            }

            let currentTotal = document.getElementById('totalTime').innerText.match(/(\d+) horas e (\d+) minutos/);
            let totalHours = (currentTotal ? parseInt(currentTotal[1], 10) : 0) + extraHours;
            let totalMinutes = (currentTotal ? parseInt(currentTotal[2], 10) : 0) + extraMinutes;

            if (totalMinutes >= 60) {
                totalHours += Math.floor(totalMinutes / 60);
                totalMinutes = totalMinutes % 60;
            }

            let metaHours = 7;
            let hoursRemaining = Math.max(metaHours - totalHours, 0);
            let minutesRemaining = (hoursRemaining === 0) ? Math.max(60 - totalMinutes, 0) : Math.max(60 - totalMinutes, 0);

            if (hoursRemaining === 0 && minutesRemaining === 0) {
                hoursRemaining = 0;
                minutesRemaining = 0;
            }

            let metaStatus = `A meta de ${metaHours} horas foi ${
                totalHours >= metaHours ? 'batida' : `não foi batida. Faltam ${hoursRemaining} horas e ${minutesRemaining} minutos.`
            }.`;

            document.getElementById('totalTime').innerText = `Tempo total trabalhado: ${totalHours} horas e ${totalMinutes} minutos.`;
            document.getElementById('metaStatus').innerText = metaStatus;
        }
    </script>
</body>
</html>
