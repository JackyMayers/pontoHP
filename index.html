<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ajuste de Ponto</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #dcdcdc;
            color: #333;
            padding: 20px;
        }
        .container {
            max-width: 600px;
            margin: auto;
            padding: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
        }
        input, textarea, button {
            margin: 5px 0;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: calc(100% - 22px);
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        .result {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Ajuste de Ponto</h1>
        <form id="timeForm">
            <h2>Informações</h2>
            <input type="text" id="name" placeholder="Nome" />
            <input type="number" id="id" placeholder="ID" />
            <input type="text" id="role" placeholder="Função" />
            
            <h2>Entradas do Bot</h2>
            <textarea id="botEntries" rows="5" placeholder="Cole as entradas do bot aqui, uma por linha (ex: 10/09/24 - 23 minutos)"></textarea>
            <button type="button" onclick="calculateBotEntries()">Calcular Tempo do Bot</button>
            
            <h2>Ajuste de Ponto Manual</h2>
            <textarea id="manualEntries" rows="5" placeholder="Nome: Nome&#10;Passaporte: xxxx&#10;Data: 11/09/2024&#10;Entrada: 19:57&#10;Saída: 21:40"></textarea>
            <button type="button" onclick="calculateManualPoint()">Calcular Ajuste de Ponto</button>
            
            <h2>Adicionar Horas e Minutos</h2>
            <input type="number" id="extraHours" placeholder="Horas" />
            <input type="number" id="extraMinutes" placeholder="Minutos" />
            <button type="button" onclick="addExtraTime()">Adicionar Tempo</button>
            
            <h2>Justificativa</h2>
            <textarea id="justification" rows="3" placeholder="Justifique caso a meta não seja batida"></textarea>
            
            <button type="button" onclick="generateFile()">Gerar Arquivo TXT</button>
        </form>
        
        <div class="result">
            <h2>Resultado</h2>
            <p id="totalTime">Tempo total trabalhado: 0 horas e 0 minutos.</p>
            <p id="daysWorked">Dias trabalhados: 0.</p>
            <p id="metaStatus">A meta de 7 horas não foi batida. Faltam 7 horas e 0 minutos.</p>
            <p id="justificationResult"></p>
        </div>
    </div>

    <script>
        let totalHoursWorked = 0;
        let totalMinutesWorked = 0;
        let daysWorked = 0;

        function parseTime(timeString) {
            let hours = 0;
            let minutes = 0;

            const hourMatch = timeString.match(/(\d+)\s*hora/);
            if (hourMatch) {
                hours = parseInt(hourMatch[1], 10);
            }

            const minuteMatch = timeString.match(/(\d+)\s*minuto/);
            if (minuteMatch) {
                minutes = parseInt(minuteMatch[1], 10);
            }

            return { hours, minutes };
        }

        function updateResults() {
            let metaHours = 7;
            let hoursRemaining = Math.max(metaHours - totalHoursWorked, 0);
            let minutesRemaining = hoursRemaining > 0 ? Math.max(60 - totalMinutesWorked, 0) : Math.max(metaHours * 60 - totalMinutesWorked, 0);

            if (hoursRemaining === 0 && minutesRemaining === 0) {
                hoursRemaining = 0;
                minutesRemaining = 0;
            }

            let metaStatus = `A meta de ${metaHours} horas foi ${
                totalHoursWorked >= metaHours ? 'batida' : `não foi batida. Faltam ${hoursRemaining} horas e ${minutesRemaining} minutos.`
            } ${daysWorked >= 3 ? 'A meta de 3 dias foi batida.' : `A meta de 3 dias não foi batida. Faltam ${Math.max(3 - daysWorked, 0)} dias.`}`;

            document.getElementById('totalTime').innerText = `Tempo total trabalhado: ${totalHoursWorked} horas e ${totalMinutesWorked} minutos.`;
            document.getElementById('daysWorked').innerText = `Dias trabalhados: ${daysWorked}.`;
            document.getElementById('metaStatus').innerText = metaStatus;
            document.getElementById('justificationResult').innerText = document.getElementById('justification').value.trim() ? `Justificativa: ${document.getElementById('justification').value.trim()}` : '';
        }

        function calculateBotEntries() {
            let botEntries = document.getElementById('botEntries').value.trim().split('\n');
            let timeMap = new Map();

            botEntries.forEach(entry => {
                let [date, time] = entry.split(' - ');
                time = time.trim();
                let timeData = parseTime(time);

                if (timeMap.has(date)) {
                    let current = timeMap.get(date);
                    current.hours += timeData.hours;
                    current.minutes += timeData.minutes;
                    if (current.minutes >= 60) {
                        current.hours += Math.floor(current.minutes / 60);
                        current.minutes = current.minutes % 60;
                    }
                } else {
                    timeMap.set(date, { hours: timeData.hours, minutes: timeData.minutes });
                }
            });

            totalHoursWorked = 0;
            totalMinutesWorked = 0;
            daysWorked = timeMap.size;

            timeMap.forEach(time => {
                totalHoursWorked += time.hours;
                totalMinutesWorked += time.minutes;
            });

            if (totalMinutesWorked >= 60) {
                totalHoursWorked += Math.floor(totalMinutesWorked / 60);
                totalMinutesWorked = totalMinutesWorked % 60;
            }

            updateResults();
        }

        function calculateManualPoint() {
            let text = document.getElementById('manualEntries').value.trim();
            let lines = text.split('\n');
            let date = '';
            let entryTime = '';
            let exitTime = '';

            lines.forEach(line => {
                if (line.startsWith('Data:')) {
                    date = line.replace('Data:', '').trim();
                } else if (line.startsWith('Entrada:')) {
                    entryTime = line.replace('Entrada:', '').trim();
                } else if (line.startsWith('Saída:')) {
                    exitTime = line.replace('Saída:', '').trim();
                }
            });

            if (!date || !entryTime || !exitTime) {
                alert('Por favor, verifique o formato da entrada. Todos os campos devem estar presentes.');
                return;
            }

            let [entryHours, entryMinutes] = entryTime.split(':').map(Number);
            let [exitHours, exitMinutes] = exitTime.split(':').map(Number);

            if (isNaN(entryHours) || isNaN(entryMinutes) || isNaN(exitHours) || isNaN(exitMinutes)) {
                alert('Por favor, insira horas e minutos válidos.');
                return;
            }

            let [day, month, year] = date.split('/').map(Number);
            let entryDateTime = new Date(year + 2000, month - 1, day, entryHours, entryMinutes);
            let exitDateTime = new Date(year + 2000, month - 1, day, exitHours, exitMinutes);

            if (exitDateTime <= entryDateTime) {
                exitDateTime.setDate(exitDateTime.getDate() + 1);
            }

            let timeDifferenceInMinutes = (exitDateTime - entryDateTime) / (1000 * 60);
            let hours = Math.floor(timeDifferenceInMinutes / 60);
            let minutes = timeDifferenceInMinutes % 60;

            totalHoursWorked += hours;
            totalMinutesWorked += minutes;

            if (totalMinutesWorked >= 60) {
                totalHoursWorked += Math.floor(totalMinutesWorked / 60);
                totalMinutesWorked = totalMinutesWorked % 60;
            }

            daysWorked += 1;

            updateResults();
        }

        function addExtraTime() {
            let extraHours = parseInt(document.getElementById('extraHours').value, 10) || 0;
            let extraMinutes = parseInt(document.getElementById('extraMinutes').value, 10) || 0;

            totalHoursWorked += extraHours;
            totalMinutesWorked += extraMinutes;

            if (totalMinutesWorked >= 60) {
                totalHoursWorked += Math.floor(totalMinutesWorked / 60);
                totalMinutesWorked = totalMinutesWorked % 60;
            }

            updateResults();
        }

        function generateFile() {
            let name = document.getElementById('name').value.trim();
            let id = document.getElementById('id').value.trim();
            let role = document.getElementById('role').value.trim();
            let justification = document.getElementById('justification').value.trim();
            
            if (!name || !id || !role) {
                alert('Por favor, preencha todos os campos obrigatórios (Nome, ID e Função).');
                return;
            }

            let filename = `${id}_${name.replace(/\s+/g, '_')}.txt`;
            let content = `ID: ${id}\nNome: ${name}\nFunção: ${role}\n\n` +
                `Tempo total trabalhado: ${totalHoursWorked} horas e ${totalMinutesWorked} minutos.\n\n` +
                `Dias trabalhados: ${daysWorked}.\n\n` +
                `A meta de 7 horas foi ${totalHoursWorked >= 7 ? 'batida' : `não foi batida. Faltam ${7 - totalHoursWorked} horas e ${60 - totalMinutesWorked} minutos.`} ` +
                `A meta de 3 dias foi ${daysWorked >= 3 ? 'batida' : `não foi batida. Faltam ${3 - daysWorked} dias.`}.\n\n` +
                `Detalhes de Ponto:\n` +
                `10/09/24 - 23 minutos\n` +
                `10/09/24 - 1 hora 56 minutos\n` +
                `09/09/24 - 1 hora 9 minutos\n` +
                `03/09/24 - 2 horas 44 minutos\n` +
                `02/09/24 - 1 hora 31 minutos\n\n` +
                `Justificativa: ${justification || 'Não, ou sim tava sem pc'}`;

            let blob = new Blob([content], { type: 'text/plain' });
            let link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
        }
    </script>
</body>
</html>
